Процедура ОбработкаПроведения(Отказ, Режим)
    
    Движения.ВзаиморасчетыПоБроням.Записывать = Истина;
    
    // Группируем суммы по броням из табличной части
    СуммыПоБроням = Новый Соответствие;
    
    Для Каждого Строка Из Услуги Цикл
        ТекущаяСумма = СуммыПоБроням.Получить(Строка.Бронь);
        Если ТекущаяСумма = Неопределено Тогда
            ТекущаяСумма = 0;
        КонецЕсли;
        СуммыПоБроням.Вставить(Строка.Бронь, ТекущаяСумма + Строка.Сумма);
    КонецЦикла;
    
    // Формируем движения по каждой брони
    Для Каждого КлючЗначение Из СуммыПоБроням Цикл
        Движение = Движения.ВзаиморасчетыПоБроням.Добавить();
        Движение.Период = Дата;
        Движение.Бронь = КлючЗначение.Ключ;
        Движение.Гость = Гость;
        Движение.Сумма = КлючЗначение.Значение;
    КонецЦикла;

КонецПроцедуры