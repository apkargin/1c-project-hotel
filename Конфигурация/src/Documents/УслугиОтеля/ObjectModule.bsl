Процедура ОбработкаПроведения(Отказ, Режим)

    Движения.ВзаиморасчетыПоБроням.Записывать = Истина;
    Движения.ЗадолженностьПоУслугам.Записывать = Истина;

    // Группируем суммы по броням из табличной части
    СуммыПоБроням = Новый Соответствие;

    Для Каждого Строка Из Услуги Цикл
        ТекущаяСумма = СуммыПоБроням.Получить(Строка.Бронь);
        Если ТекущаяСумма = Неопределено Тогда
            ТекущаяСумма = 0;
        КонецЕсли;
        СуммыПоБроням.Вставить(Строка.Бронь, ТекущаяСумма + Строка.Сумма);
    КонецЦикла;

    // Формируем движения по каждой брони
    Для Каждого Строки Из СуммыПоБроням Цикл
        Движение = Движения.ВзаиморасчетыПоБроням.Добавить();
        Движение.Период = Дата;
        Движение.Бронь = Строки.Ключ;
        Движение.Гость = Гость;
        Движение.Сумма = Строки.Значение;
        Движение.Вид = Перечисления.ВидДвижения.Оплата;
    КонецЦикла;

    // Группируем услуги (схлопываем одинаковые)
    СуммыПоУслугам = Новый Соответствие;

    Для Каждого Строка Из Услуги Цикл
        ТекущаяСумма = СуммыПоУслугам.Получить(Строка.Услуга);
        Если ТекущаяСумма = Неопределено Тогда
            ТекущаяСумма = 0;
        КонецЕсли;
        СуммыПоУслугам.Вставить(Строка.Услуга, ТекущаяСумма + Строка.Сумма);
    КонецЦикла;

    // Формируем движения по услугам
    Для Каждого Строки Из СуммыПоУслугам Цикл
        ДвижениеУслуги = Движения.ЗадолженностьПоУслугам.Добавить();
        ДвижениеУслуги.Период = Дата;
        ДвижениеУслуги.Гость = Гость;
        ДвижениеУслуги.Услуга = Строки.Ключ;
        ДвижениеУслуги.Сумма = Строки.Значение;
        ДвижениеУслуги.Вид = Перечисления.ВидДвижения.Оплата;
    КонецЦикла;

КонецПроцедуры