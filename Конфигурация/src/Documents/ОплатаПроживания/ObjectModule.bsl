Процедура ОбработкаПроведения(Отказ, Режим)
	// 1. Получаем Цену Брони
	ЦенаБрони = Бронь.Цена; 
	
	// 2. Считаем, сколько УЖЕ оплачено ДРУГИМИ документами
	// Для этого берем остаток на "МоментВремени()" документа, но ИСКЛЮЧАЯ сам документ.
	// Самый простой способ:
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(СУММА(Взаиморасчеты.Сумма), 0) КАК ОплаченоДругими
		|ИЗ
		|	РегистрНакопления.ВзаиморасчетыПоБроням КАК Взаиморасчеты
		|ГДЕ
		|	Взаиморасчеты.Бронь = &Бронь
		|	И Взаиморасчеты.Регистратор <> &Ссылка"; // Исключаем этот документ
	
	Запрос.УстановитьПараметр("Бронь", Бронь);
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	ОплаченоДругими = 0;
	Если Выборка.Следующий() Тогда
		ОплаченоДругими = Выборка.ОплаченоДругими;
	КонецЕсли;
	
	// 3. Проверяем переплату
	// (То, что было + То, что сейчас платим)
	Если (ОплаченоДругими + СуммаОплаты) > ЦенаБрони Тогда
		
		ОстатокДолга = ЦенаБрони - ОплаченоДругими;
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Ошибка! Сумма оплаты превышает остаток долга. Максимально можно внести: " + ОстатокДолга;
		Сообщение.Поле = "СуммаОплаты";
		Сообщение.Сообщить();
		
		Отказ = Истина; // Отменяем проведение
		Возврат;
		
	КонецЕсли;
	
	// --- 1. Движения по регистру (то, что мы делали раньше) ---
	Движение = Движения.ВзаиморасчетыПоБроням.Добавить(); // Проверьте имя вашего регистра!
	Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
	Движение.Период = Дата;
	Движение.Бронь = Бронь;
	Движение.Гость = Гость; // Или Клиент, как у вас назван реквизит
	Движение.Сумма = СуммаОплаты;
	
	// Обязательно записываем движения ПЕРЕД расчетом, чтобы текущая оплата тоже учлась
	Движения.ВзаиморасчетыПоБроням.Записывать = Истина;
	Движения.Записать(); 
	
	// --- 2. Автоматическое изменение статуса Брони ---
	
	// Если Бронь не выбрана, выходим
	Если Бронь.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	// Получаем объект брони, чтобы можно было его изменить
	БроньОбъект = Бронь.ПолучитьОбъект();
	
	// Если бронь уже отменена, не трогаем её
	Если БроньОбъект.СтатусБронирования = Перечисления.СтатусБронирования.Отменено Тогда
		Возврат;
	КонецЕсли;
	
	// Считаем, сколько ВСЕГО оплачено по этой брони (включая этот документ)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(ВзаиморасчетыОстатки.СуммаОстаток, 0) КАК Оплачено
		|ИЗ
		|	РегистрНакопления.ВзаиморасчетыПоБроням.Остатки(, Бронь = &Бронь) КАК ВзаиморасчетыОстатки";
	

	Запрос.УстановитьПараметр("Бронь", Бронь);
	Выборка = Запрос.Выполнить().Выбрать();
	
	СуммаВсегоОплачено = 0;
	Если Выборка.Следующий() Тогда
		СуммаВсегоОплачено = Выборка.Оплачено;
	КонецЕсли;
	
	// Получаем полную стоимость брони (из реквизита "Цена" в Бронировании)
	ПолнаяЦена = БроньОбъект.Цена; 
	
	// Защита от деления на ноль, если цена вдруг 0
	Если ПолнаяЦена = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// --- 3. Проверка условия 30% ---
	ПроцентОплаты = (СуммаВсегоОплачено / ПолнаяЦена) * 100;
	
	Если ПроцентОплаты >= 30 Тогда
		// Если статус еще "Ожидает оплаты", меняем его
		Если БроньОбъект.СтатусБронирования = Перечисления.СтатусБронирования.ОжидаетОплаты Тогда
			БроньОбъект.СтатусБронирования = Перечисления.СтатусБронирования.Оплачено;
			БроньОбъект.Записать();
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

