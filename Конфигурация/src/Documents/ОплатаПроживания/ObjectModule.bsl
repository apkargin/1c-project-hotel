Процедура ОбработкаПроведения(Отказ, Режим)

	ЦенаБрони = Бронь.Цена;
	Если ЗначениеЗаполнено(Акция) и Акция.ПроживаниеГостей Тогда
		Если Акция.ТипСкидки = Перечисления.ТипСкидки.Сумма Тогда
			Если ЦенаБрони > Акция.ЗначениеСкидки Тогда
				ЦенаБрони = ЦенаБрони - Акция.ЗначениеСкидки;
			Иначе
				ЦенаБрони = 0;
			КонецЕсли;			
		Иначе
			Если Акция.ЗначениеСкидки > 100 Тогда
				ЦенаБрони = 0;
			Иначе
				ЦенаБрони = ЦенаБрони - ЦенаБрони *Акция.ЗначениеСкидки/100;
			КонецЕсли;			
		КонецЕсли;		
	КонецЕсли;
	// 1. Считаем общую сумму к оплате (номер + услуги)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	СезонныеАкцииУслуги.ТипСкидки КАК ТипСкидки,
	|	СезонныеАкцииУслуги.Значение КАК Значение,
	|	ОплатаПроживанияУслуги.Сумма КАК Сумма
	|ИЗ
	|	Документ.ОплатаПроживания.Услуги КАК ОплатаПроживанияУслуги
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СезонныеАкции.Услуги КАК СезонныеАкцииУслуги
	|		ПО ОплатаПроживанияУслуги.Услуга = СезонныеАкцииУслуги.Услуга
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОплатаПроживания КАК ОплатаПроживания
	|		ПО ОплатаПроживанияУслуги.Ссылка = ОплатаПроживания.Ссылка
	|ГДЕ
	|	ОплатаПроживания.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Выборка = Запрос.Выполнить().Выбрать();
	СуммаУслуг = 0;
	Пока Выборка.Следующий() Цикл
		СуммаУслуги = 0;
		Если Выборка.ТипСкидки = Null Тогда
			СуммаУслуг = СуммаУслуг + Выборка.Сумма;
		Иначе
			Если Выборка.ТипСкидки = Перечисления.ТипСкидки.Сумма Тогда				
				Если Выборка.Сумма > Выборка.Значение Тогда
					СуммаУслуги = Выборка.Сумма - Выборка.Значение;
				КонецЕсли;
			Иначе
				Если Акция.ЗначениеСкидки < 100 Тогда
					СуммаУслуги = Выборка.Сумма - Выборка.Сумма*Выборка.Значение/100;
				КонецЕсли;					
			КонецЕсли;	
			СуммаУслуг = СуммаУслуг + СуммаУслуги;
		КонецЕсли;		
	КонецЦикла;
			
	ОбщаяСуммаКОплате = ЦенаБрони + СуммаУслуг;
	
	Сообщить("Цена брони: " + ЦенаБрони);
	Сообщить("Сумма услуг: " + СуммаУслуг);
	Сообщить("Общая сумма к оплате: " + ОбщаяСуммаКОплате);
	
	// 2. Считаем, сколько УЖЕ оплачено ДРУГИМИ документами
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(СУММА(Взаиморасчеты.Сумма), 0) КАК ОплаченоДругими
		|ИЗ
		|	РегистрНакопления.ВзаиморасчетыПоБроням КАК Взаиморасчеты
		|ГДЕ
		|	Взаиморасчеты.Бронь = &Бронь
		|	И Взаиморасчеты.Регистратор <> &Ссылка
		|	И Взаиморасчеты.Вид = &ВидОплата";
	
	Запрос.УстановитьПараметр("Бронь", Бронь);
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ВидОплата", Перечисления.ВидДвижения.Оплата);
	
	Выборка = Запрос.Выполнить().Выбрать();
	ОплаченоДругими = 0;
	Если Выборка.Следующий() Тогда
		ОплаченоДругими = Выборка.ОплаченоДругими;
	КонецЕсли;
	
	Сообщить("Оплачено другими документами: " + ОплаченоДругими);
	Сообщить("Текущая сумма оплаты: " + СуммаОплаты);
	
	// 3. Записываем движение по взаиморасчетам (оплата брони)
	Движение = Движения.ВзаиморасчетыПоБроням.Добавить();
	Движение.Период = Дата;
	Движение.Бронь = Бронь;
	Движение.Гость = Гость; 
	Движение.Сумма = СуммаОплаты;
	Движение.Вид = Перечисления.ВидДвижения.Оплата;
	
	Движения.ВзаиморасчетыПоБроням.Записывать = Истина;
	
	// 4. Записываем движения по услугам в отдельный регистр (со схлопыванием)
	ТаблицаУслуг = Новый ТаблицаЗначений;
	ТаблицаУслуг.Колонки.Добавить("Услуга");
	ТаблицаУслуг.Колонки.Добавить("Сумма");
	
	Для Каждого СтрокаУслуги Из Услуги Цикл
		// Ищем, есть ли уже такая услуга
		НайденнаяСтрока = Неопределено;
		Для Каждого СтрокаТаблицы Из ТаблицаУслуг Цикл
			Если СтрокаТаблицы.Услуга = СтрокаУслуги.Услуга Тогда
				НайденнаяСтрока = СтрокаТаблицы;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если НайденнаяСтрока = Неопределено Тогда
			НоваяСтрока = ТаблицаУслуг.Добавить();
			НоваяСтрока.Услуга = СтрокаУслуги.Услуга;
			НоваяСтрока.Сумма = СтрокаУслуги.Сумма;
		Иначе
			НайденнаяСтрока.Сумма = НайденнаяСтрока.Сумма + СтрокаУслуги.Сумма;
		КонецЕсли;
	КонецЦикла;
	
	// Теперь записываем схлопнутые движения
	Для Каждого СтрокаТаблицы Из ТаблицаУслуг Цикл
		ДвижениеУслуги = Движения.ЗадолженностьПоУслугам.Добавить();
		ДвижениеУслуги.Период = Дата;
		ДвижениеУслуги.Гость = Гость;
		ДвижениеУслуги.Услуга = СтрокаТаблицы.Услуга;
		ДвижениеУслуги.Сумма = СтрокаТаблицы.Сумма;
		ДвижениеУслуги.Вид = Перечисления.ВидДвижения.Продажа;
	КонецЦикла;
	
	Движения.ЗадолженностьПоУслугам.Записывать = Истина;
	
	Движения.Записать();
	
	// --- 5. Автоматическое изменение статуса Брони ---
	
	Если Бронь.Пустая() Тогда
		Сообщить("ВЫХОД: Бронь пустая");
		Возврат;
	КонецЕсли;
	
	БроньОбъект = Бронь.ПолучитьОбъект();
	
	// Получаем текущий статус из регистра
	ЗапросСтатуса = Новый Запрос;
	ЗапросСтатуса.Текст = 
	    "ВЫБРАТЬ ПЕРВЫЕ 1
	    |    БронированиеНомеров.СтатусБрони КАК СтатусБрони
	    |ИЗ
	    |    РегистрСведений.БронированиеНомеров КАК БронированиеНомеров
	    |ГДЕ
	    |    БронированиеНомеров.Регистратор = &Бронь";
	
	ЗапросСтатуса.УстановитьПараметр("Бронь", Бронь);
	ВыборкаСтатуса = ЗапросСтатуса.Выполнить().Выбрать();
	
	ТекущийСтатус = Неопределено;
	Если ВыборкаСтатуса.Следующий() Тогда
	    ТекущийСтатус = ВыборкаСтатуса.СтатусБрони;
	КонецЕсли;
	
	Сообщить("Текущий статус из регистра: " + ТекущийСтатус);
	
	// Если отменена — выходим
	Если ТекущийСтатус = Перечисления.СтатусБронирования.Отменено Тогда
		Сообщить("ВЫХОД: Бронь отменена");
	    Возврат;
	КонецЕсли;
	
	// 6. Считаем всего оплачено (включая текущий документ)
	СуммаВсегоОплачено = ОплаченоДругими + СуммаОплаты;
	Сообщить("Всего оплачено: " + СуммаВсегоОплачено);
	
	Если ОбщаяСуммаКОплате = 0 Тогда
		Сообщить("ВЫХОД: Общая сумма = 0");
		Возврат;
	КонецЕсли;
	
	// --- 7. Проверка условия 30% ---
	ПроцентОплаты = (СуммаВсегоОплачено / ОбщаяСуммаКОплате) * 100;
	Сообщить("Процент оплаты: " + ПроцентОплаты + "%");
	
	Если ПроцентОплаты >= 30 Тогда
		
	    Если ТекущийСтатус = Перечисления.СтатусБронирования.ОжидаетОплаты Тогда
	            
            Движение = Движения.БронированиеНомеров.Добавить();
            Движение.Номер = БроньОбъект.БронируемыйНомер;
            Движение.ДатаНачала = БроньОбъект.ДатаЗаезда;
            Движение.ДатаКонца = БроньОбъект.ДатаВыезда;
            Движение.СтатусБрони = Перечисления.СтатусБронирования.Оплачено;
            Движение.Гость = Гость;
            Движение.Период = Дата;
            
            Движения.БронированиеНомеров.Записывать = Истина;
			
			Сообщить("Движение добавлено — статус Оплачено");
	    Иначе
			Сообщить("Статус НЕ ОжидаетОплаты, а: " + ТекущийСтатус);
	    КонецЕсли;
	Иначе
		Сообщить("Процент < 30%, не хватает для оплаты");
	КонецЕсли;

КонецПроцедуры


Функция ПолучитьСезонныеАкцию(Дата)
	Запрос = Новый Запрос;
	Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |	СезонныеАкции.ЗначениеСкидки,
    |	СезонныеАкции.Услуги.(
    |		Ссылка,
    |		НомерСтроки,
    |		Услуга,
    |		ТипСкидки,
    |		Значение)
    |ИЗ
    |	Документ.СезонныеАкции КАК СезонныеАкции
    |ГДЕ
    |	СезонныеАкции.ДатаНачала <= &Дата
    |	И СезонныеАкции.ДатаОкончания >= &Дата";
	
	Запрос.УстановитьПараметр("Дата", Дата);
	Выборка = Запрос.Выполнить().Выбрать();
	Возврат Выборка;
КонецФункции