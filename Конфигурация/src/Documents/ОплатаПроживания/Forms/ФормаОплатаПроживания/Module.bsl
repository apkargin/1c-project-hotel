&НаКлиенте
Процедура УслугиЦенаПриИзменении(Элемент)
    
    ТекущаяСтрока = Элементы.Услуги.ТекущиеДанные;
    
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
    КонецЕсли;
    
    ТекущаяСтрока.Сумма = ТекущаяСтрока.Цена * ТекущаяСтрока.Количество;
    
КонецПроцедуры

&НаКлиенте
Процедура УслугиКоличествоПриИзменении(Элемент)
    
    ТекущаяСтрока = Элементы.Услуги.ТекущиеДанные;
    
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
    КонецЕсли;
    
    ТекущаяСтрока.Сумма = ТекущаяСтрока.Цена * ТекущаяСтрока.Количество;
    
КонецПроцедуры
&НаКлиенте
Процедура УслугиУслугаПриИзменении(Элемент)
    
    
    ТекущаяСтрока = Элементы.Услуги.ТекущиеДанные;
    
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
    КонецЕсли;
    
    Если НЕ ЗначениеЗаполнено(ТекущаяСтрока.Услуга) Тогда
        Возврат;
    КонецЕсли;
    
    
    // Вызываем сервер для получения цены
    Цена = ПолучитьЦенуУслуги(ТекущаяСтрока.Услуга, Объект.Дата);
    
    
    ТекущаяСтрока.Цена = Цена;
    
    // Пересчитываем сумму
    Если ТекущаяСтрока.Количество > 0 Тогда
        ТекущаяСтрока.Сумма = ТекущаяСтрока.Цена * ТекущаяСтрока.Количество;
    КонецЕсли;
    
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьЦенуУслуги(Услуга, Дата)
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |    СтоимостьУслуг.Стоимость КАК Стоимость
        |ИЗ
        |    РегистрСведений.СтоимостьУслуг.СрезПоследних(&Дата, Услуга = &Услуга) КАК СтоимостьУслуг";
    
    Запрос.УстановитьПараметр("Дата", Дата);
    Запрос.УстановитьПараметр("Услуга", Услуга);
    
    Результат = Запрос.Выполнить().Выбрать();
    
    Если Результат.Следующий() Тогда
        Возврат Результат.Стоимость;
    Иначе
        Возврат 0;
    КонецЕсли;
    
КонецФункции
&НаКлиенте
Процедура БроньПриИзменении(Элемент)
    // Как только выбрали бронь, сами подставляем клиента из неё
    ДанныеБрони = ПолучитьДанныеБрониНаСервере(Объект.Бронь);
    Объект.Гость = ДанныеБрони.Гость;
    // Можно сразу и сумму подставить (остаток долга), если хочешь
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьДанныеБрониНаСервере(БроньСсылка)
    Результат = Новый Структура("Гость");
    // Здесь предполагается, что в Бронировании поле называется "ОсновнойГость" или "Клиент"
    Результат.Гость = БроньСсылка.ОсновнойГость; 
    Возврат Результат;
КонецФункции
